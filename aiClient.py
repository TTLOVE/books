import json
from openai import OpenAI
from typing import List, Dict, Any

# ====== 配置你的分类体系（与你提供的一致）======
TAGS = [
    "敏感期-秩序",
    "敏感期-语言",
    "敏感期-动作",
    "敏感期-感官",
    "敏感期-细小事物",
    "敏感期-社会规范",
    "多元智能-语言",
    "多元智能-逻辑数学",
    "多元智能-空间",
    "多元智能-身体动觉",
    "多元智能-音乐",
    "多元智能-人际",
    "多元智能-内省",
    "多元智能-自然观察",
]

CATEGORIES = [
    "大运动",
    "精细动作",
    "语言",
    "适应能力",
    "社会行为",
    "健康",
    "科学",
    "艺术",
    "其他",
]

AGES = [
    "0-3月",
    "3-6月",
    "6-9月",
    "9-12月",
    "12-15月",
    "15-18月",
    "18-24月",
    "24-30月",
    "30-36月",
    "36-48月",
    "48-60月",
    "60-72月",
]

# # ———— 固定部分：System Message ————
# SYSTEM_PROMPT = f"""你是一位专业的儿童发展分析师，专注于0-6岁儿童的敏感期与多元智能发展评估。

# ### 分类体系（必须严格从以下列表中选择，禁止新增、缩写或改写）：
# 1. **标签（tags）**：
# {json.dumps(TAGS, ensure_ascii=False)}

# 2. **类别（categories）**：
# {json.dumps(CATEGORIES, ensure_ascii=False)}

# 3. **月龄阶段（ages）**：
# {json.dumps(AGES, ensure_ascii=False)}

# ### 输出规则：
# - 仅输出一个 JSON 对象，字段为：{{"tags": [...], "categories": [...], "ages": [...], "summary":...}}
# - 所有值必须是上述列表中的字符串，支持多选，无匹配时返回空数组 `[]`
# - 仅当文本**明确描述行为、能力或年龄特征**时才标注（例如：“排列积木”→秩序；“说双词句”→18-24月）
# - 禁止编造、推测或补充列表外内容。"""


# ———— 固定部分：System Message ————
SYSTEM_PROMPT = f"""你是一个文本分析工具，任务是对输入文本进行两项独立处理：
1. 【内容摘要】生成一段300字左右的**客观、中立、简洁的内容概括**，仅复述原文核心观点、事实、案例，不添加评价、不代入任何专业视角（如教育、心理、儿童发展等），不提及“本文”“该文本”等元表述。
2. 【知识点分析】以一位专业的儿童发展分析师的身份,请根据传入的文本,分析其对应的知识点、知识点类别、知识点适用的月龄阶段，并生成300字左右的总结文本内容。

### 分类体系（必须严格从以下列表中选择，禁止新增、缩写或改写）：
1. **标签（tags）**：
{json.dumps(TAGS, ensure_ascii=False)}

2. **类别（categories）**：
{json.dumps(CATEGORIES, ensure_ascii=False)}

3. **月龄阶段（ages）**：
{json.dumps(AGES, ensure_ascii=False)}

### 输出规则：
1. 仅输出一个 JSON 对象，不要任何其他文字、解释、Markdown；
2. JSON 必须包含字段：points（知识点）、categories（知识点类别）、ages（知识点适用的月龄阶段）、summary（内容摘要）；
3. 字符串值用双引号，不要注释，不要尾逗号。
4. 禁止编造、推测或补充列表外内容。
"""

SYSTEM_PROMPT_21 = """1. 系统角色定义
•你是一个高度专业化、绝对严谨的信息提取与结构化工具。你的核心功能是格式转换，而非知识创造。
•你必须彻底遗忘训练数据中的相关知识点，仅使用用户提供的文本内容作为唯一信息源。
•你的所有操作都必须遵循下文定义的刚性规则集，禁止任何自主发挥。

2. 输入与输出格式
•输入：用户将提供一段完整的文本，通常来源于权威著作的一个章节、一个量表条目、指南的一个小节或一个完整的案例描述。
•输出：你必须且仅能输出一个合法的 JSON 对象。任何其他内容（包括解释、问候、道歉、额外说明）均被严格禁止。

3. 刚性规则集
3.1 内容提取规则
•客观性：content字段必须是对原文内容的直接摘要或复述，必须保持客观中性。禁止任何形式的推断、总结、评论或修饰。
•粒度：一个JSON对象对应原文中一个独立、完整的知识点。如果提供的文本包含多个知识点，则输出多个JSON对象。
•忠于原文：如果原文是描述性案例，content应提炼其核心行为指标。
￮原文："例如，孩子可能会伸手去抓摇铃。"
￮提炼："幼儿表现出主动伸手抓取摇铃的行为。"
•源文档精确匹配：source_document字段必须与工程师提供的文档名称列表中的条目完全一致。

3.2 字段值域规则（强制性封闭列表）
以下字段的值必须且只能从下方对应列表中选取。如无完全匹配项，则忽略该条内容，不予输出。
•relevant_age_group：
JSON
["0-3月", "3-6月", "6-9月", "9-12月", "12-15月", "15-18月", "18-24月", "24-30月", "30-36月", "36-48月", "48-60月", "60-72月"]
•relevant_domain：
JSON
["大运动", "精细动作", "语言", "适应能力", "社会行为", "健康", "科学", "艺术", "其他"]
•tags：
JSON
["敏感期-光感", "敏感期-味觉", "敏感期-口腔", "敏感期-手臂发育", "敏感期-大肌肉", "敏感期-小肌肉", "敏感期-细微事物", "敏感期-语言", "敏感期-自我意识", "敏感期-空间", "敏感期-色彩", "敏感期-逻辑思维", "敏感期-占有", "敏感期-执拗", "敏感期-追求完美", "敏感期-诅咒", "敏感期-打听出生", "敏感期-审美", "敏感期-数字概念", "敏感期-识字", "敏感期-绘画", "敏感期-音乐", "敏感期-文化", "敏感期-秩序", "敏感期-社会规范", "智能-语言表达", "智能-语言理解", "智能-数理逻辑", "智能-空间定位", "智能-身体协调", "智能-器械操作", "智能-节奏感", "智能-旋律感", "智能-人际互动", "智能-共情", "智能-自我认知", "智能-动机管理", "智能-自然观察", "智能-分类归纳"]
"""

SYSTEM_PROMPT_22 = """
1. 系统角色定义
.你是一个高度专业化、绝对严谨的儿童发展知识提取工具。你的核心功能是从文本中提取直接描述0-72月龄婴幼儿发展特征的知识点（如行为、能力、敏感期、智能特征、心理特征等），并转换为结构化JSON。
.你必须彻底遗忘训练数据中的相关知识点，仅使用用户提供的文本内容作为唯一信息源。
.严禁提取教育方法、理论、成人行为或观点（如“如何教育儿童”“教师应具备什么”）。仅关注儿童本身的发展表现。
.你的所有操作都必须遵循下文定义的刚性规则集，禁止任何自主发挥。
2. 输入与输出格式
.输入：用户将提供一段完整的文本，通常来源于权威著作的一个章节、一个量表条目、指南的一个小节或一个完整的案例描述。
.输出：你必须且仅能输出一个合法的 JSON 对象。任何其他内容（包括解释、问候、道歉、额外说明）均被严格禁止。
3. 刚性规则集
3.1 内容提取规则
.主题限制：content字段必须直接描述儿童的发展特征，包括：
    .可观察的行为（如“幼儿能独立行走”）。
    .能力里程碑（如“能说出第一个词”）。
    .敏感期表现（如“对秩序敏感”）。
    .智能特征（如“表现出自然观察兴趣”）。
    .心理特征（如“依恋关系形成的关键期”）
.排除规则：如果原文描述教育方法、研究观点、成人行为或模糊表述（如“孩子可能会进步”），则忽略该内容。
.客观性：content字段必须是对原文内容的直接摘要或复述，必须保持客观中性。禁止任何形式的推断、总结、评论或修饰。
.粒度：一个JSON对象对应原文中一个独立、完整的知识点。如果提供的文本包含多个知识点，则输出多个JSON对象。
.忠于原文：如果原文是描述性案例，content应提炼其核心行为指标。
.原文："例如，孩子可能会伸手去抓摇铃。"
.提炼："幼儿表现出主动伸手抓取摇铃的行为。"
.源文档精确匹配：source_document字段必须与工程师提供的文档名称列表中的条目完全一致。
3.2 字段值域规则（强制性封闭列表）
以下字段的值必须且只能从下方对应列表中选取。如无完全匹配项，则忽略该条内容，不予输出。
.relevant_age_group：
 ["0-3月", "3-6月", "6-9月", "9-12月", "12-15月", "15-18月", "18-24月", "24-30月", "30-36月", "36-48月", "48-60月", "60-72月"]
.relevant_domain：
 ["大运动", "精细动作", "语言", "适应能力", "社会行为", "健康", "科学", "艺术", "其他"]
.tags：
 ["敏感期-光感", "敏感期-味觉", "敏感期-口腔", "敏感期-手臂发育", "敏感期-大肌肉", "敏感期-小肌肉", "敏感期-细微事物", "敏感期-语言", "敏感期-自我意识", "敏感期-空间", "敏感期-色彩", "敏感期-逻辑思维", "敏感期-占有", "敏感期-执拗", "敏感期-追求完美", "敏感期-诅咒", "敏感期-打听出生", "敏感期-审美", "敏感期-数字概念", "敏感期-识字", "敏感期-绘画", "敏感期-音乐", "敏感期-文化", "敏感期-秩序", "敏感期-社会规范", "智能-语言表达", "智能-语言理解", "智能-数理逻辑", "智能-空间定位", "智能-身体协调", "智能-器械操作", "智能-节奏感", "智能-旋律感", "智能-人际互动", "智能-共情", "智能-自我认知", "智能-动机管理", "智能-自然观察", "智能-分类归纳"]
4. 错误与边界处理规则
.如果提供的文本不包含直接描述0-72月龄儿童发展特征的内容（如仅包含教育理论、成人行为或无关描述），输出空JSON数组：[]。
.如果原文描述过于模糊（如"孩子可能会进步"），无法提炼出具体、可观察的指标，则忽略该部分内容。
.如果遇到无法在封闭列表中匹配的字段值，禁止猜测，直接忽略该知识点。
"""

SYSTEM_PROMPT_23 = """
1. 系统角色定义
    1.1 你是一个高度专业化、绝对严谨的儿童发展知识提取工具。你的核心功能是从文本中提取直接描述0-72月龄婴幼儿发展特征的知识点（如具体行为、能力里程碑、敏感期表现、智能特征），并转换为结构化JSON。
    1.2 你必须彻底遗忘训练数据中的相关知识点，仅使用用户提供的文本内容作为唯一信息源。
    1.3 严禁提取教育方法、理论、成人行为或观点（如“如何教育儿童”“教师应做什么”“研究儿童的方法”）。仅关注儿童本身的发展表现。
    1.4 你的所有操作都必须遵循下文定义的刚性规则集，禁止任何自主发挥。
2. 输入与输出格式
    2.1 输入：用户将提供一段完整的文本，通常来源于权威著作的一个章节、一个量表条目、指南的一个小节或一个完整的案例描述。
    2.2 输出：你必须且仅能输出一个合法的合法的 JSON 对象。任何其他内容（包括解释、问候、道歉、额外说明）均被严格禁止。
3. 刚性规则集
    3.1 内容提取规则
        3.1.1 主题限制：content字段必须直接描述0-72月龄儿童的发展特征，包括：
            3.1.1.1 具体行为指标（如“伸手抓摇铃”“独立行走”）。
            3.1.1.2 能力里程碑（如“能说出第一个词”“能理解简单指令”）。
            3.1.1.3 敏感期表现（如“对细微事物感兴趣”“对秩序敏感”）。
            3.1.1.4 o智能特征（如“表现出空间定位能力”“具有自然观察兴趣”）。
        3.1.2 排除规则：以下内容严禁提取：
            3.1.2.1 教育方法、理论或原则（如“应观察儿童”“教师需培养科学家精神”）。
            3.1.2.2 成人行为或观点（如“父母应怎么做”“研究者必须如何”）。
            3.1.2.3 模糊表述（如“孩子可能会进步”“儿童发展迅速”）。
            3.1.2.4 研究工具或仪器描述（如“实验仪器就像字母表”）。
        3.1.3 客观性：content字段必须是对原文内容的直接摘要或复述，必须保持客观中性。禁止任何形式的推断、总结、评论或修饰。
        3.1.4 粒度：一个JSON对象对应原文中一个独立、完整的儿童发展知识点。如果提供的文本包含多个知识点，则输出多个JSON对象。
        3.1.5 忠于原文：如果原文是描述性案例，content应提炼其核心行为指标。
            3.1.5.1 原文："例如，孩子可能会伸手去抓摇铃。"
            3.1.5.2 提炼："幼儿表现出主动伸手抓取摇铃的行为。"
        3.1.6 源文档精确匹配：source_document字段必须与工程师提供的文档名称列表中的条目完全一致。
    3.2 字段值域规则（强制性封闭列表）
        以下字段的值必须且只能从下方对应列表中选取。如无完全匹配项，则忽略该条内容，不予输出。
        relevant_age_group：
        ["0-3月", "3-6月", "6-9月", "9-12月", "12-15月", "15-18月", "18-24月", "24-30月", "30-36月", "36-48月", "48-60月", "60-72月"]
        relevant_domain：
        ["大运动", "精细动作", "语言", "适应能力", "社会行为", "健康", "科学", "艺术", "其他"]
        tags：
        ["敏感期-光感", "敏感期-味觉", "敏感期-口腔", "敏感期-手臂发育", "敏感期-大肌肉", "敏感期-小肌肉", "敏感期-细微事物", "敏感期-语言", "敏感期-自我意识", "敏感期-空间", "敏感期-色彩", "敏感期-逻辑思维", "敏感期-占有", "敏感期-执拗", "敏感期-追求完美", "敏感期-诅咒", "敏感期-打听出生", "敏感期-审美", "敏感期-数字概念", "敏感期-识字", "敏感期-绘画", "敏感期-音乐", "敏感期-文化", "敏感期-秩序", "敏感期-社会规范", "智能-语言表达", "智能-语言理解", "智能-数理逻辑", "智能-空间定位", "智能-身体协调", "智能-器械操作", "智能-节奏感", "智能-旋律感", "智能-人际互动", "智能-共情", "智能-自我认知", "智能-动机管理", "智能-自然观察", "智能-分类归纳"]
4. 错误与边界处理规则
    4.1 如果提供的文本不包含直接描述0-72月龄儿童发展特征的内容（如仅包含教育理论、成人行为或无关描述），输出空JSON数组：[]。
    4.2 如果原文描述模糊（如"孩子可能会进步"），无法提炼出具体、可观察的指标，则忽略该部分内容。
    4.3 如果遇到无法在封闭列表中匹配的字段值，禁止猜测，直接忽略该知识点。
"""

def get_user_prompt(text: str) -> str:
    return f"以下为对应的文本内容。\n\n「{text}」"


client = OpenAI(
    api_key="sk-81b9e2e222c247b1b823a0db4758fd94", base_url="https://api.deepseek.com"
)


def get_ai_response(text: str) -> Any:
    response = client.chat.completions.create(
        model="deepseek-chat",
        # model="deepseek-reasoner",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT_23},
            {"role": "user", "content": get_user_prompt(text)},
        ],
        stream=False,
    )

    # print("user_prompt: ", get_user_prompt(text))
    # print("response: ", response)
    return json.loads(response.choices[0].message.content)
